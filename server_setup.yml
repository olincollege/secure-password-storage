---
- name: Install git & create git server
  hosts: 127.0.0.1
  connection: local
  module_defaults:
    shell:
      chdir: ${HOME}
  # remote_user: noname
  become: yes
  tasks:
    - name: Install openssh-server
      apt:
        name: ssh
        state: latest

    - name: Install git
      apt:
        name: git
        state: latest
        update_cache: yes

    - name: Install ufw
      apt:
        name: ufw
        state: latest
        update_cache: yes

    - name: Create git user
      user:
        name: git

    - name: Create ssh directory
      ansible.builtin.file:
        path: /home/git/.ssh
        state: directory
        mode: "0755"

    - name: Copy ssh keys to git user
      ansible.builtin.copy:
        src: /.ssh/authorized_keys
        dest: /home/git/.ssh/authorized_keys
        owner: git
        mode: "0700"

    # - name: Upload public SSH key to "git" user
    #   authorized_key:
    #     user: git
    #     key: "{{ lookup('file', '~/.ssh/key.pub') }}" # need to create key on the server & replace this path with that later
    #     state: present

    # - name: Set permissions on ~/.ssh directory
    #   file:
    #     path: "/home/git/.ssh"
    #     state: directory
    #     mode: "0700"
    #   become_user: git

    # might need to add something to to ensure "git" can authenticate via ssh

    # - name: Create a bare repository on the server
    #   command: git init --bare
    #   args:
    #     chdir: /home/git/passwords.git
    #   become_user: git

    # - name: Add remote repository to local Git project
    #   command: git remote add origin git@10.26.92.128:/home/git/passwords.git
    #   args:
    #     chdir: /home/passwords

    # - name: Push changes to the remote repository
    #   command: git push origin master
    #   args:
    #     chdir: /home/passwords
